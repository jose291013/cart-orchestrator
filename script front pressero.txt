<!-- START DISTRIBUTION LIST â€“ BROCHURE-DIST -->

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>
;(function(){
  if (!window.location.pathname.includes('/product/brochure-dist')) return;

  // ========= CONFIG =========
  const RENDER_BASE = "https://cart-orchestrator.onrender.com"; // <-- TODO: mets ton URL Render
  const ENDPOINT_VALIDATE = `${RENDER_BASE}/validate-addresses`;
  const ENDPOINT_ADD_CART = `${RENDER_BASE}/add-to-cart-distribution`;

  // shipping method id (Ã  dÃ©finir)
  const SHIPPING_METHOD_ID = "e4080000-568f-0050-4d3d-08da0cdc8a47"; // <-- TODO si besoin

  // UrlName du produit (utilisÃ© par ton serveur pour resolveProductId)
  const URL_NAME = "brochure-dist";

  // Upload slot Ã  conserver (optionnel)
  const FILE_UPLOAD_ID = "fileUploads[2]";

  // ========= STATE =========
  let validatedList = null;

  // ========= DOM helpers =========
  function getUserEmail(){
    return (document.getElementById("correo")?.textContent || "").trim();
  }
  function getSiteDomain(){
    return (document.getElementById("tienda")?.textContent || "").trim();
  }

  function escapeHtml(s){
    return (s ?? '').toString()
      .replace(/&/g,'&amp;').replace(/</g,'&lt;')
      .replace(/>/g,'&gt;').replace(/"/g,'&quot;')
      .replace(/'/g,'&#039;');
  }

  function debounce(fn, wait){
    let t;
    return function(){
      clearTimeout(t);
      t = setTimeout(()=>fn(), wait);
    };
  }

  // ========= Dedupe helpers =========
  function norm(s) {
    return (s || '')
      .toString()
      .trim()
      .toLowerCase()
      .replace(/\s+/g,' ')
      .replace(/[â€™']/g,"'")
      .replace(/[.,;]+/g,' ')
      .replace(/\s+/g,' ')
      .trim();
  }

  function addressKey({address, zip, city}) {
    return [norm(address), norm(zip), norm(city)].join('|');
  }

  function mergeDuplicates(list) {
  const map = new Map();
  for (const row of list || []) {
    const qty = parseInt(row.qty, 10) || 0;
    if (qty <= 0) continue;

    const key = addressKey(row);
    if (!key || key === '||') continue;

    if (!map.has(key)) map.set(key, { ...row, qty });
    else map.get(key).qty += qty;
  }
  return [...map.values()];
}


  // ========= UI message =========
  function showMsg(txt, type="info"){
    const el = document.getElementById("distMsg");
    if (!el) return;
    if (!txt) { el.style.display="none"; el.textContent=""; return; }
    el.style.display="block";
    el.textContent = txt;
    el.className = "dist-msg " + type;
  }

  // ========= Calculator options reader (Pressero DOM) =========
  // Options[i].Key (hidden) + Options[i].Value (select) :contentReference[oaicite:1]{index=1}
  function readPricingOptionsFromDOM(){
  const opts = [];
  const keyInputs = [...document.querySelectorAll('input[type="hidden"][id^="Options["][id$="].Key"]')];

  for (const keyEl of keyInputs) {
    const m = keyEl.id.match(/^Options\[(\d+)\]\.Key$/);
    if (!m) continue;

    const idx = m[1];
    const key = keyEl.value;

    const valEl = document.querySelector(`#Options\\[${idx}\\]\\.Value`);
    const value = valEl ? (valEl.value ?? '') : '';

    if (key) opts.push({ Key: key, Value: value });
  }
  return opts;
}


  // ========= Table read/write =========
  function getListRawFromTable() {
  return [...document.querySelectorAll('#distTable tbody tr')]
    .map(tr => ({
      address: tr.querySelector('.dist-address')?.value.trim() || '',
      zip:     tr.querySelector('.dist-zip')?.value.trim() || '',
      city:    tr.querySelector('.dist-city')?.value.trim() || '',
      qty:     parseInt(tr.querySelector('.dist-qty')?.value, 10) || 0
    }))
    .filter(r => (r.address || r.zip || r.city) && r.qty > 0);
}


  function repaintTableFromList(list) {
    const tb = document.querySelector('#distTable tbody');
    tb.innerHTML = '';
    list.forEach(r => addRow(r.address, r.zip, r.city, r.qty, {skipSave:true}));
    saveList();
  }

  function saveList() {
    const raw = getListRawFromTable();
    const merged = mergeDuplicates(raw);

    // si doublons -> on fusionne automatiquement
    if (raw.length && merged.length < raw.length) {
      showMsg(`Doublons dÃ©tectÃ©s : ${raw.length - merged.length} ligne(s) fusionnÃ©e(s).`, "ok");
      repaintTableFromList(merged);
      return;
    }

    localStorage.setItem("dist_list_cache", JSON.stringify(merged));
    validatedList = null;
    const btnCart = document.getElementById("addToCartDistBtn");
    if (btnCart) btnCart.disabled = true;
  }

  function addRow(a='', z='', c='', q='', opts={}) {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><input class="dist-address" value="${escapeHtml(a)}" placeholder="Adresse complÃ¨te"></td>
      <td><input class="dist-zip" value="${escapeHtml(z)}" placeholder="Code postal"></td>
      <td><input class="dist-city" value="${escapeHtml(c)}" placeholder="Ville"></td>
      <td style="width:140px;"><input class="dist-qty" type="number" min="1" value="${escapeHtml(String(q))}" placeholder="1"></td>
      <td class="dist-actions"><button class="removeRowBtn" type="button">Supprimer</button></td>
    `;
    document.querySelector('#distTable tbody').appendChild(tr);

    tr.querySelectorAll('input').forEach(inp=>{
      inp.addEventListener('input', debounce(saveList, 250));
      inp.addEventListener('blur', debounce(saveList, 250));
    });

    if (!opts.skipSave) saveList();
  }

  // ========= Import CSV / XLSX =========
  function injectFileIntoPresseroUpload(f) {
    const inp = document.getElementById(FILE_UPLOAD_ID);
    if (!inp) return setTimeout(()=>injectFileIntoPresseroUpload(f), 200);

    const dt = new DataTransfer();
    dt.items.add(f);
    inp.files = dt.files;

    const nm = inp.closest('.file-upload-control')?.querySelector('.file-upload-name');
    if (nm) nm.value = f.name;

    console.log('âœ… Fichier injectÃ© dans', FILE_UPLOAD_ID, f.name);
  }

  function pick(row, keys){
    for (const k of keys) {
      if (row[k] != null && String(row[k]).trim() !== '') return row[k];
    }
    const lower = Object.fromEntries(Object.entries(row).map(([k,v])=>[k.toLowerCase(), v]));
    for (const k of keys) {
      const lk = k.toLowerCase();
      if (lower[lk] != null && String(lower[lk]).trim() !== '') return lower[lk];
    }
    return '';
  }

  function rowsToList(rows){
    const list = [];
    for (const r of rows || []) {
      const address = String(pick(r, ['address','adresse','addr','street','rue','direccion','direcciÃ³n'])).trim();
      const zip     = String(pick(r, ['zip','postal','postcode','cp','code postal','codigo postal','cÃ³digo postal'])).trim();
      const city    = String(pick(r, ['city','ville','ciudad','town'])).trim();
      const qtyRaw  = pick(r, ['qty','quantity','quantite','quantitÃ©','qte','cantidad']);
      const qty     = parseInt(String(qtyRaw).replace(',', '.'), 10) || 0;

      if ((address || zip || city) && qty > 0) list.push({ address, zip, city, qty });
    }
    return mergeDuplicates(list);
  }

function readQuantitiesFromDOM() {
  // 1) tente Quantities[0], Quantities[1]...
  const els = [
    ...document.querySelectorAll('input[id^="Quantities["], input[name^="Quantities["]')
  ];

  const arr = [];
  for (const el of els) {
    const v = String(el.value || "").trim();
    const n = parseInt(v.replace(",", "."), 10);
    if (!Number.isNaN(n)) arr.push(n);
  }
  if (arr.length) return arr;

  // 2) fallback Q1..Q10
  const q = [];
  for (let i = 1; i <= 10; i++) {
    const el = document.getElementById(`Q${i}`);
    if (!el) continue;
    const n = parseInt(String(el.value || "").replace(",", "."), 10);
    if (!Number.isNaN(n)) q.push(n);
  }
  return q;
}


  // ========= Calls Render =========
  async function validateAddresses() {
    const userEmail = getUserEmail();
    if (!userEmail) return showMsg("Email utilisateur introuvable (#correo).", "err");

    const list = mergeDuplicates(getListRawFromTable());
    if (!list.length) return showMsg("Liste vide.", "err");

    showMsg("Validation des adressesâ€¦", "info");

    const r = await fetch(ENDPOINT_VALIDATE, {
      method: "POST",
      headers: { "Content-Type":"application/json" },
      body: JSON.stringify({
  userEmail,
  urlName: URL_NAME,
  shippingMethod: SHIPPING_METHOD_ID,
  pricingOptions,
  validatedList,
  otherQuantities
})

    });

    const data = await r.json().catch(()=>({}));
    if (!r.ok) return showMsg(data.error || "Erreur validation adresses.", "err");

    validatedList = data.validated || [];
    if (!validatedList.length) return showMsg("Aucune adresse validÃ©e.", "err");

    showMsg(`OK âœ… ${validatedList.length} adresse(s) validÃ©e(s).`, "ok");
    document.getElementById("addToCartDistBtn").disabled = false;
  }

  async function addToCartDistribution() {
    const userEmail = getUserEmail();
    if (!userEmail) return showMsg("Email utilisateur introuvable (#correo).", "err");
    if (!validatedList?.length) return showMsg("Valide d'abord les adresses.", "err");

    const pricingOptions = readPricingOptionsFromDOM();
    if (!pricingOptions.length) return showMsg("Impossible de lire les options du calculateur.", "err");

    if (!SHIPPING_METHOD_ID || SHIPPING_METHOD_ID.includes("TODO")) {
      return showMsg("ShippingMethodId manquant. Renseigne SHIPPING_METHOD_ID dans le script.", "err");
    }
const qs = readQuantitiesFromDOM();        // ex: [1000, 32]
const otherQuantities = qs.slice(1);       // ex: [32]

    showMsg("Ajout au panierâ€¦", "info");

    const r = await fetch(ENDPOINT_ADD_CART, {
      method: "POST",
      headers: { "Content-Type":"application/json" },
      body: JSON.stringify({
        userEmail,
        urlName: URL_NAME,
        shippingMethod: SHIPPING_METHOD_ID,
        pricingOptions,
        validatedList,
        // optionnel, si tu veux envoyer aussi:
        siteDomain: getSiteDomain()
      })
    });

    const data = await r.json().catch(()=>({}));
    if (!r.ok) return showMsg(data.error || "Erreur ajout panier.", "err");

    showMsg(`Panier OK âœ… ${data.added} item(s) ajoutÃ©s.`, "ok");
  }

  // ========= INIT UI =========
  document.addEventListener('DOMContentLoaded', ()=>{

    const css = document.createElement('style');
    css.textContent = `
      #distribution-list-container { margin:20px 0; font-family:sans-serif; }
      #distFileInput,#addRowBtn,#validateAddressesBtn,#addToCartDistBtn { margin-right:10px; margin-bottom:10px; }
      #distTable { width:100%; border-collapse:collapse; margin-top:10px; }
      #distTable th,#distTable td { border:1px solid #ccc; padding:8px; vertical-align:top; }
      #distTable th { background:#f5f5f5; text-align:left; }
      #distTable input { width:100%; box-sizing:border-box; padding:6px; }
      .removeRowBtn { background:#e74c3c; color:#fff; border:none; padding:6px 10px; cursor:pointer; border-radius:4px; }
      .removeRowBtn:hover { background:#c0392b; }
      .dist-actions { white-space:nowrap; }
      .dist-msg { margin-top:10px; padding:10px; border-radius:6px; font-size:12px; }
      .dist-msg.info { background:#eef4ff; border:1px solid #cfe0ff; color:#1d3b8b; }
      .dist-msg.ok   { background:#e7f7ee; border:1px solid #bfe6cf; color:#1f6f3d; }
      .dist-msg.err  { background:#fdecea; border:1px solid #f5c2c0; color:#a1241c; }
    `;
    document.head.appendChild(css);

    const notes = document.querySelector('.orderNotesArea');
    if (!notes) return console.warn('orderNotesArea introuvable');

    notes.insertAdjacentHTML('beforebegin', `
      <div id="distribution-list-container">
        <h3>Liste de distribution</h3>

        <input type="file" id="distFileInput" accept=".csv,.xls,.xlsx">
        <button id="addRowBtn" type="button">+ Ajouter une ligne</button>
        <button id="validateAddressesBtn" type="button">âœ… Valider mes adresses</button>
        <button id="addToCartDistBtn" type="button" disabled>ðŸ›’ Mettre au panier</button>

        <table id="distTable">
          <thead>
            <tr>
              <th>Adresse</th>
              <th>Code postal</th>
              <th>Ville</th>
              <th style="width:140px;">QuantitÃ©</th>
              <th class="dist-actions">Action</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>

        <div id="distMsg" class="dist-msg info" style="display:none;"></div>
      </div>
    `);

    document.getElementById('addRowBtn').addEventListener('click', ()=>addRow());

    document.querySelector('#distTable tbody').addEventListener('click', e=>{
      if (e.target.classList.contains('removeRowBtn')) {
        e.target.closest('tr').remove();
        saveList();
      }
    });

    document.getElementById("validateAddressesBtn").addEventListener("click", validateAddresses);
    document.getElementById("addToCartDistBtn").addEventListener("click", addToCartDistribution);

    document.getElementById('distFileInput').addEventListener('change', ev=>{
      const f = ev.target.files[0];
      if (!f) return;

      const ext = f.name.split('.').pop().toLowerCase();

      const proc = (rows)=>{
        const list = rowsToList(rows);
        if (!list.length) return showMsg("Aucune ligne valide trouvÃ©e (adresse/cp/ville/quantitÃ©).", "err");

        document.querySelector('#distTable tbody').innerHTML = '';
        list.forEach(r => addRow(r.address, r.zip, r.city, r.qty, {skipSave:true}));
        saveList();
        injectFileIntoPresseroUpload(f);
        showMsg(`Import OK âœ… ${list.length} adresse(s) chargÃ©e(s).`, "ok");
      };

      if (ext === 'csv') {
        Papa.parse(f, { header:true, skipEmptyLines:true, complete: res => proc(res.data || []) });
      } else {
        const rd = new FileReader();
        rd.onload = e=>{
          const wb = XLSX.read(new Uint8Array(e.target.result), {type:'array'});
          const data = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]] || {});
          proc(data || []);
        };
        rd.readAsArrayBuffer(f);
      }
    });

    // restore cache (optionnel)
    try {
      const cached = JSON.parse(localStorage.getItem("dist_list_cache") || "null");
      if (Array.isArray(cached) && cached.length) {
        document.querySelector('#distTable tbody').innerHTML = '';
        cached.forEach(r => addRow(r.address, r.zip, r.city, r.qty, {skipSave:true}));
        saveList();
      }
    } catch(_) {}

    // premiÃ¨re ligne
    addRow();
  });

})();
</script>

